{{/*
  这个文件是 hugoplate 主题 image.html partial 的一个智能覆盖版本。
  它能自动判断图片是来自 /assets 目录的全局资源，还是与文章在一起的页面资源。
*/}}
{{ $src := .Src }}
{{ $context := .Context }}
{{ $alt := .Alt }}
{{ $class := .Class }}
{{ $width := .Width | default "" }}
{{ $height := .Height | default "" }}
{{ $loading := .Loading | default "lazy" }}

{{ $image := "" }}
{{ $image_fallback := "" }}

{{/* 检查图片资源是否存在 */}}
{{ if $src }}
  {{/* 首先，尝试将其作为页面资源（与 .md 文件在同一个文件夹）来查找 */}}
  {{ $page_resource := $context.Resources.GetMatch $src }}

  {{ if $page_resource }}
    {{ $image = $page_resource }}
  {{ else }}
    {{/* 如果不是页面资源，就尝试将其作为全局资源（在 /assets 目录）来查找 */}}
    {{ $global_resource := resources.Get $src }}
    {{ if $global_resource }}
      {{ $image = $global_resource }}
    {{ else }}
      {{/* 如果两处都找不到，就打印错误信息 */}}
      {{ errorf "Image not found: src %s in page %s" $src $context.File.Path }}
    {{ end }}
  {{ end }}
{{ end }}


{{ if $image }}
  {{/* 获取图片的原始宽度和高度 */}}
  {{ $original_width := $image.Width }}
  {{ $original_height := "auto" }}
  {{ if $image.Height }}
    {{ $original_height = $image.Height }}
  {{ end }}

  {{/* 如果 Front Matter 提供了 width 或 height，就用它，否则用图片的原始尺寸 */}}
  {{ $width = $width | default $original_width }}
  {{ $height = $height | default $original_height }}
  
  {{/* 定义要生成的图片尺寸，可以根据需要修改 */}}
  {{ $sizes := slice "320" "640" "768" "1024" "1280" "1536" }}
  {{ $processable := and (not (in (slice ".svg" ".gif") $image.MediaType.Suffix)) (eq (hugo.IsProduction) true) }}

  <picture>
    {{ if $processable }}
      {{/* 生成 webp 格式的图片集 */}}
      {{ range $size := $sizes }}
        {{ $resized := ($image.Resize (printf "%sx%s" $size "auto")).RelPermalink }}
        <source
          type="image/webp"
          media="(max-width: {{ $size }}px)"
          srcset="{{ ($image.Resize (printf "%sx%s webp" $size "auto")).RelPermalink }}" />
      {{ end }}
      <source type="image/webp" srcset="{{ ($image.Resize (printf "%sx%s webp" $width $height)).RelPermalink }}" />
    {{ end }}

    {{/* 生成原始格式 (jpg/png) 的图片集 */}}
    {{ range $size := $sizes }}
      {{ $resized := ($image.Resize (printf "%sx%s" $size "auto")).RelPermalink }}
      <source
        media="(max-width: {{ $size }}px)"
        srcset="{{ $resized }}" />
    {{ end }}

    {{/* 默认的 img 标签，用于旧版浏览器或作为 fallback */}}
    <img
      class="{{ $class }}"
      src="{{ ($image.Resize (printf "%sx%s" $width $height)).RelPermalink }}"
      width="{{ $width }}"
      height="{{ $height }}"
      alt="{{ $alt }}"
      loading="{{ $loading }}" />
  </picture>
{{ end }}
