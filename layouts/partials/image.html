{{/*
  这是 image.html 的最终修复版本。
  它会主动从页面的 Front Matter (.Params) 读取 width 和 height。
*/}}
{{ $src := .Src }}
{{ $page := .Context }}
{{ $alt := .Alt | default $page.Title }}

{{ $image := "" }}

{{/* 检查 $src 是否被定义 */}}
{{ if $src }}
  {{/* 首先，尝试作为页面资源（与md文件在同一目录）查找 */}}
  {{ with $page.Resources.GetMatch $src }}
    {{ $image = . }}
  {{ else }}
    {{/* 如果找不到，就去 /assets 目录里查找全局资源 */}}
    {{ with resources.Get $src }}
      {{ $image = . }}
    {{ end }}
  {{ end }}
{{ end }}


{{/* 如果成功找到了图片资源 */}}
{{ if $image }}
  {{/* 
    关键修复：不再依赖 .Width，而是直接从页面的 Front Matter ($page.Params) 读取。
    如果 Front Matter 中没有，则回退到图片的原始尺寸。
  */}}
  {{ $width := $page.Params.width | default $image.Width }}
  {{ $height := $page.Params.height | default $image.Height }}

  {{/* 检查尺寸是否有效 */}}
  {{ if or (not (gt $width 0)) (not (gt $height 0)) }}
    {{ errorf "Image partial: Final check failed for image '%s' on page '%s'. Ensure 'width' and 'height' are set in the Front Matter and are greater than 0." $src $page.File.Path }}
  {{ end }}

  {{/* 调整图片尺寸 */}}
  {{ $resized := $image.Resize (printf "%dx%d" $width $height) }}

  <img
    class="{{ .Class }}"
    src="{{ $resized.RelPermalink }}"
    width="{{ $resized.Width }}"
    height="{{ $resized.Height }}"
    alt="{{ $alt }}"
    loading="lazy" />

{{ else if $src }}
  {{/* 如果提供了src但找不到图片，就报错 */}}
  {{ errorf "Image partial: Image '%s' not found for page '%s'. Make sure it exists in /assets/ or alongside the content file, and the path in Front Matter has NO leading slash." $src $page.File.Path }}
{{ end }}
