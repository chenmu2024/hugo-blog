{{/*
  这是 image.html 的最终修复版本。
  它现在可以正确处理从模板传入的 'Loading' 参数 (e.g., "eager")，
  如果未提供，则默认为 "lazy"。
*/}}
{{ $src := .Src }}
{{ $page := .Context }}
{{ $alt := .Alt | default $page.Title }}

{{/* 
  决定加载策略：
  优先使用传入的 .Loading 参数，如果没有，则默认值为 "lazy"。
*/}}
{{ $loadingStrategy := .Loading | default "lazy" }}

{{ $image := "" }}

{{/* 检查 $src 是否被定义 */}}
{{ if $src }}
  {{/* 首先，尝试作为页面资源（与md文件在同一目录）查找 */}}
  {{ with $page.Resources.GetMatch $src }}
    {{ $image = . }}
  {{ else }}
    {{/* 如果找不到，就去 /assets 目录里查找全局资源 */}}
    {{ with resources.Get $src }}
      {{ $image = . }}
    {{ end }}
  {{ end }}
{{ end }}


{{/* 如果成功找到了图片资源 */}}
{{ if $image }}
  {{ $width := .Width | default $image.Width }}
  {{ $height := .Height | default $image.Height }}
  
  {{ with .DisplayXL }}
    {{ $image = $image.Resize (printf "%s webp" .) }}
  {{ else }}
    {{ $image = $image.Resize (printf "%dx%d webp" $width $height) }}
  {{ end }}

  <img
    class="{{ .Class }}"
    src="{{ $image.RelPermalink }}"
    width="{{ $image.Width }}"
    height="{{ $image.Height }}"
    alt="{{ $alt }}"
    loading="{{ $loadingStrategy }}" />

{{ else if $src }}
  {{/* 如果提供了src但找不到图片，就报错 */}}
  {{ errorf "Image partial: Image '%s' not found for page '%s'." $src $page.File.Path }}
{{ end }}
